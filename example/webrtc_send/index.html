<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>libdatachannel media sender example</title>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
</head>

<body>

    <p>Please enter the offer provided to you by the sender application: </p>
    <textarea cols="80" rows="25"></textarea>
    <button id="submit">Submit</button>

    <button id="more">More</button>

    <video id="video-element" muted></video>

    <script>

        let pc = null;
        let dc = null;

        let websocket;

        async function waitGatheringComplete() {
            return new Promise((resolve) => {
                if (pc.iceGatheringState === 'complete') {
                    resolve();
                } else {
                    pc.addEventListener('icegatheringstatechange', () => {
                        if (pc.iceGatheringState === 'complete') {
                            resolve();
                        }
                    });
                }
            });
        }


        async function createPeerConnection() {
            pc = new RTCPeerConnection({
                bundlePolicy: 'max-bundle',
                iceServers: [{ urls: ['stun:stun.l.google.com:19302'] }]
            });

            pc.ondatachannel = (evt) => {

                console.log('ON DATA CHANNEL');

                dc = evt.channel;

                dc.onopen = () => {
                    console.log("IS open");


                    window.addEventListener('keypress', () => {
                        dc.send("{}");
                        console.log("keydown");
                    })
                };

                dc.onmessage = (evt) => {
                    console.log('EVENT MESSAGE ', evt);
                };

                dc.onclose = () => {
                    console.log('ON CLOSE');
                };

            };

            pc.onicegatheringstatechange = (state) => {
                if (pc.iceGatheringState === 'complete') {
                    // We only want to provide an answer once all of our candidates have been added to the SDP.
                    const answer = pc.localDescription;
                    document.querySelector('textarea').value = JSON.stringify({ "type": answer.type, sdp: answer.sdp });
                    document.querySelector('p').value = 'Please paste the answer in the sender application.';
                    alert('Please paste the answer in the sender application.');
                }
            }

            pc.ontrack = (evt) => {
                const videoElement = document.getElementById('video-element');
                videoElement.srcObject = evt.streams[0];

                console.log("receive track");
                
                videoElement.play();
            };


            return pc;
        }


        function startWs() {
            websocket = new WebSocket('ws://192.168.2.148:8000/' + "peerid");
            websocket.onopen = () => {
                console.log('OPEN');
            }

            websocket.onmessage = async (evt) => {
                if (typeof evt.data !== 'string') {
                    return;
                }
                const message = JSON.parse(evt.data);
                console.log(message);
                if (message.type == "offer") {
                    const pc = await createPeerConnection();
                    await pc.setRemoteDescription(message);

                    await pc.setLocalDescription(await pc.createAnswer());
                    await waitGatheringComplete();

                    const answer = pc.localDescription;

                    websocket.send(JSON.stringify({
                        id: "mycustomid",
                        type: answer.type,
                        sdp: answer.sdp,
                    }));

                    console.log('awnser send');
                }
            }

        }


        document.getElementById('more').addEventListener('click', async () => {
            dc.send("salut mon ami , joystick control de fou");
        });

        document.getElementById('submit').addEventListener('click', async () => {
            startWs();
        })
    </script>

</body>

</html>